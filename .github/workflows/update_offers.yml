name: Aggiorna Offerte Eurospin

on:
  schedule:
    - cron: '0 */4 * * *'  # Ogni 4 ore: 00:00, 04:00, 08:00, 12:00, 16:00, 20:00 UTC
  workflow_dispatch:        # Esecuzione manuale
  push:
    branches: [ main ]     # Avvia anche con un push su main (per test)

jobs:
  update-offers:
    runs-on: ubuntu-24.04  # ESPLICITO: Ubuntu 24.04 LTS (non piÃ¹ 'latest')
    timeout-minutes: 30
    
    steps:
    # 1. SCARICA IL CODICE
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. CONFIGURA PYTHON 3.11
    - name: Setup Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    # 3. INSTALLA DIPENDENZE PYTHON - VERSIONI SPECIFICHE TESTATE
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install selenium==4.39.0
        pip install webdriver-manager==4.0.1
        pip install requests==2.31.0
        pip install beautifulsoup4==4.12.2
        pip install lxml==4.9.3
        pip install python-dotenv==1.0.0
        
        python -c "import selenium; print(f'âœ… Selenium v{selenium.__version__}')"
        python -c "from webdriver_manager.chrome import ChromeDriverManager; print('âœ… WebDriver Manager pronto')"

    # 4. INSTALLA CHROME - METODO UFFICIALE GOOGLE (FORMATTATO CORRETTAMENTE)
    - name: Install Chrome and dependencies
      run: |
        sudo apt-get update
        # Installa dipendenze necessarie per Ubuntu 24.04
        # ATTENZIONE: YAML richiede indentazione precisa. Ogni riga deve iniziare esattamente con 10 spazi dopo il backslash
        sudo apt-get install -y \
          wget \
          unzip \
          libxss1 \
          libappindicator3-1 \
          libindicator7 \
          fonts-liberation \
          libasound2t64 \
          libnspr4 \
          libnss3 \
          libx11-xcb1 \
          libxcomposite1 \
          libxcursor1 \
          libxdamage1 \
          libxi6 \
          libxtst6 \
          xdg-utils
        
        wget -q -O /tmp/chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo apt-get install -y /tmp/chrome.deb
        rm /tmp/chrome.deb
        echo "âœ… Chrome installato:"
        google-chrome --version 2>&1 | head -1

    # 5. INSTALLA PHP PER UBUNTU 24.04 (PHP 8.3)
    - name: Install PHP for Ubuntu 24.04
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          php \
          php-curl \
          php-json \
          php-mbstring \
          php-xml \
          php-cli
        
        echo "âœ… PHP installato:"
        php --version
        echo "âœ… Estensioni PHP:"
        php -m | grep -E "(curl|json|mbstring|xml|cli)" || true

    # 6. PREPARA AMBIENTE PER CHROME HEADLESS
    - name: Setup X Virtual Frame Buffer (Xvfb)
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        echo "âœ… Xvfb avviato su DISPLAY=:99"

    # 7. ESEGUI LO SCRIPT CON DIAGNOSTICA DETTAGLIATA
    - name: Run Eurospin Update Automation
      env:
        FIREBASE_SECRET: ${{ secrets.FIREBASE_SECRET }}
        PYTHONUNBUFFERED: 1
        DISPLAY: ":99"
      run: |
        echo "========================================"
        echo "ðŸš€ AVVIO AUTOMAZIONE EUROSPIN"
        echo "========================================"
        
        echo "ðŸ“‹ VERIFICA AMBIENTE:"
        echo "Python:" $(python --version)
        echo "PHP:" $(php --version | head -1)
        echo "Chrome:" $(google-chrome --version 2>&1 | head -1)
        
        echo "ðŸ“ FILE ESSENZIALI:"
        ls -la trigger_eurospin.php estrai_eurospin.py requirements.txt 2>/dev/null || echo "âš ï¸  File mancanti!"
        
        echo "â–¶ï¸  ESECUZIONE SCRIPT PRINCIPALE..."
        php trigger_eurospin.php
        EXIT_CODE=$?
        
        if [ $EXIT_CODE -eq 0 ]; then
          echo "========================================"
          echo "âœ… SCRIPT COMPLETATO CON SUCCESSO!"
          echo "========================================"
          
          if [ -f "promozioni_eurospin.json" ]; then
            echo "ðŸ“Š STATISTICHE:"
            echo "Dimensione:" $(ls -lh promozioni_eurospin.json | awk '{print $5}')
            echo "Anteprima:" $(head -c 200 promozioni_eurospin.json)
            echo "..."
          fi
          
          echo "âœ… L'automazione ora partirÃ  automaticamente ogni 4 ore"
          
        else
          echo "========================================"
          echo "âŒ SCRIPT FALLITO - CODICE: $EXIT_CODE"
          echo "========================================"
          
          echo "ðŸ” DIAGNOSTICA RAPIDA:"
          
          if [ -f "promozioni_eurospin.json" ]; then
            echo "âš ï¸  File JSON creato ma errore nell'invio Firebase"
            echo "Ultime righe del file:"
            tail -5 promozioni_eurospin.json
          fi
          
          if [ -f "promozioni_eurospin.json" ]; then
            echo "âœ… Estrazione Python riuscita"
          else
            echo "âŒ Estrazione Python fallita"
          fi
          
          exit $EXIT_CODE
        fi

    # 8. DIAGNOSTICA AVANZATA (solo se fallisce)
    - name: Advanced Diagnostics on Failure
      if: failure()
      run: |
        echo "========================================"
        echo "ðŸ”§ DIAGNOSTICA AVANZATA - ANALISI ERRORI"
        echo "========================================"
        
        echo "1. VERIFICA CHROMEDRIVER:"
        python -c "
        try:
            from webdriver_manager.chrome import ChromeDriverManager
            from selenium.webdriver.chrome.service import Service
            from selenium.webdriver.chrome.options import Options
            print('âœ… WebDriver Manager: OK')
            options = Options()
            options.add_argument('--headless')
            options.add_argument('--no-sandbox')
            print('âœ… Chrome options: OK')
        except Exception as e:
            print(f'âŒ Errore: {str(e)[:100]}')
        " 2>/dev/null || echo "âš ï¸  Errore test ChromeDriver"
        
        echo "2. VERIFICA FIREBASE CONNECTION:"
        curl -s -o /dev/null -w "%{http_code}" \
          "https://offerte-spesa-default-rtdb.europe-west1.firebasedatabase.app/.json" \
          && echo "âœ… Firebase raggiungibile" || echo "âš ï¸  Firebase non raggiungibile"
        
        echo "3. VERIFICA SITO EUROSPIN:"
        curl -s -o /dev/null -w "%{http_code}" \
          "https://www.eurospin.it" \
          && echo "âœ… Sito Eurospin raggiungibile" || echo "âš ï¸  Sito non raggiungibile"
        
        echo "4. CHECK VARIABILI D'AMBIENTE:"
        echo "FIREBASE_SECRET configurato:" $( [ -n "$FIREBASE_SECRET" ] && echo "âœ… SI" || echo "âŒ NO" )
        echo "DISPLAY:" $DISPLAY
        echo "PYTHONUNBUFFERED:" $PYTHONUNBUFFERED
        
        echo "5. ULTIMI FILE CREATI:"
        find . -name "*.json" -o -name "*.log" -o -name "*.txt" 2>/dev/null | head -10 | xargs ls -la 2>/dev/null || echo "Nessun file trovato"
        
        echo "========================================"
        echo "ðŸ“‹ CONSIGLI PER RISOLVERE:"
        echo "1. Controlla Firebase Console > Database > Rules"
        echo "2. Verifica GitHub Secrets > FIREBASE_SECRET"
        echo "3. Controlla che trigger_eurospin.php usi FIREBASE_SECRET"
        echo "========================================"
